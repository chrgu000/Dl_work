<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
    <link rel="stylesheet" href="/js/plugins/layui-v2/layui/css/layui.css" media="all" />
    <title>权限检测</title>
</head>
<body>
    <div style="margin:50px auto;width:80%" class="iframe">
        <form class="layui-form">
            <p>权限检测中.....</p>
        </form>
    </div>

    <!-- <script src="../../js/jquery-1.11.0.min.js"></script>
-->
<script src="/js/plugins/layui-v2/layui/layui.all.js"></script>
<!-- <script src="../js/mui/mui.min.js"></script>
-->
<script>
        var $=layui.$,form=layui.form;
        
        $(function(){
            if (GetQueryString("code")!=null) {
            
                $.ajax({
                    type: "Post",
                    traditional: true,
                    url: "/Handler/WeiXinHandler.ashx",
                    dataType: "Json",
                    data: { "Action": "Wx_Login", "code": GetQueryString("code") },
                    success: function (data) {
                        console.log(data)
                        // for (var o in data) {
                        //     document.write(o + ":" + data[o]);
                        //     document.write("<br />")
                        // }
                        // document.write(GetQueryString("code"))
                        if (data.flag == 0) {
                          //  window.location.href = "norole.html";
                        }
                        if (data.flag == 1) {
                            // window.location.href = "arrearlist.html";
                          //  window.location.href = "index.html";
                           var  url=GetQueryString('state');
                           console.log(url)
                           window.location.href =url+'&orderType=1';
                        } else if(data.flag==2){
                           // document.write("该手机号码绑定有多个账号，请选择后重新登录！");
                            var html='<h2>手机号码绑定有多个账号，请选择后重新登录</h2><br/>';
                            html+='<select id="select_user"><option value>请选择登录账号</option>';
                            $.each(data.users,function(i,v){
                                html+='<option value="'+v.strLoginName+'">'+v.strLoginName+'  '+v.strUserName+'</option>';
                            })
                            html+='</select><br/><button id="login" type="button" class="layui-btn" phone="'+data.UserId+'">登录</button>';
                            $('form').html(html);
                            form.render();
                            
                            //  document.write(data.flag)
                            //   document.write(data.message)
                      // window.location.href = "norole.html";
                        }
                    }, error: function (err, xhr, e) {
                        alert("err")
                    }
                });
            } else {
               // window.location.href = "norole.html";
            }

        })

        $(document).on('click','#login',function(){
            if ($('#select_user').val()=='') {
                layer.alert('请选择登录账号',{icon:2});
                return false;
            }
var phone=$(this).attr('phone');
    $.ajax({
        type: "Post",
        url: "/Handler/WeiXinHandler.ashx",
        dataType: "Json",
        data: {
            "Action": "SelectUserToLogin",
             "phone":phone,
             "ccuscode":$('#select_user').val()
        },
        success: function(res) {
            if (res.flag != 1) {
                layer.alert(res.message,{icon:2});
                return false;
            }
           window.location.href=GetQueryString('state');


        }
            })
        })
     
      

        function GetQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]);
            return null;
        }
    </script>
</body>
</html>